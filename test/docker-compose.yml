---
services:
  mlflow_auth_db:
    image: public.ecr.aws/docker/library/postgres:16.4-alpine3.20
    environment:
      POSTGRES_USER: mlflow
      POSTGRES_PASSWORD: mlflow
      POSTGRES_DB: mlflow
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U mlflow"]
      interval: 5s
      timeout: 5s
      retries: 5
  mlflow_db:
    image: public.ecr.aws/docker/library/postgres:16.4-alpine3.20
    environment:
      POSTGRES_USER: mlflow
      POSTGRES_PASSWORD: mlflow
      POSTGRES_DB: mlflow
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U mlflow"]
      interval: 5s
      timeout: 5s
      retries: 5
  mlflow:
    image: ghcr.io/ministryofjustice/analytical-platform-mlflow:local
    build: .
    environment:
      # MLFLOW_SERVER_DEV_MODE: "true"
      MLFLOW_AUTH_DATABASE_URI: postgresql://mlflow:mlflow@mlflow_auth_db:5432/mlflow
      MLFLOW_SERVER_BACKEND_STORE_URI: postgresql://mlflow:mlflow@mlflow_db:5432/mlflow
    ports:
      - "5000:5000"
    depends_on:
      mlflow_auth_db:
        condition: service_healthy
      mlflow_db:
        condition: service_healthy
 # OAuth2-proxy
  oauth2-proxy:
    depends_on:
      - mlflow
    image: quay.io/oauth2-proxy/oauth2-proxy:v7.1.3
    container_name: oauth2-proxy
    expose:
      - "3000"
    ports:
      - "3000:3000"
    environment:
      OAUTH2_PROXY_PROVIDER: github
      OAUTH2_PROXY_EMAIL_DOMAINS: "*"
      OAUTH2_PROXY_CLIENT_ID: ""
      OAUTH2_PROXY_CLIENT_SECRET: ""
      OAUTH2_PROXY_COOKIE_SECRET: ""
      OAUTH2_PROXY_COOKIE_EXPIRE: 3h
      OAUTH2_PROXY_COOKIE_REFRESH: 1h
      OAUTH2_PROXY_UPSTREAMS: http://mlflow:5000
      OAUTH2_PROXY_HTTP_ADDRESS: 0.0.0.0:3000
      OAUTH2_PROXY_REDIRECT_URL: https://codespace-name-3000.app.github.dev/oauth2/callback
      OAUTH2_PROXY_COOKIE_SECURE: "false"
      OAUTH2_PROXY_SKIP_JWT_BEARER_TOKENS: "true"
      OAUTH2_PROXY_PASS_AUTHORIZATION_HEADER: "true"
      OAUTH2_PROXY_PASS_ACCESS_TOKEN: "true"
      OAUTH2_PROXY_PASS_USER_HEADERS: "true"
      OAUTH2_PROXY_SET_XAUTHREQUEST: "true"
      OAUTH2_PROXY_SET_AUTHORIZATION_HEADER: "true"
      OAUTH2_PROXY_SKIP_PROVIDER_BUTTON: "true"
